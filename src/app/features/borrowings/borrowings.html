<div class="p-2">
  <!-- Toast Messages -->
  <p-toast></p-toast>
  
  <!-- Confirm Dialog -->
  <p-confirmdialog></p-confirmdialog>
  
  <!-- Filter Section -->
  <p-card class="mb-2">
    <ng-template pTemplate="header">
      <div class="px-3 pt-3">
        <h2 class="text-2xl font-bold m-0 text-900">Borrowings Management</h2>
        <!-- <p class="text-sm text-600 mt-1 mb-0">Track and manage book borrowings</p> -->
      </div>
    </ng-template>
    
    <div class="formgrid grid">
      <!-- Book Title Search -->
      <div class="field col-12 md:col-6 lg:col-3">
        <p-floatlabel>
          <input 
            pInputText 
            id="bookTitleFilter"
            [(ngModel)]="bookTitleFilter"
            (input)="applyFilters()"
            placeholder="Search by book title or author" 
            class="w-full" />
          <label for="bookTitleFilter">Search Book</label>
        </p-floatlabel>
      </div>

      <!-- Member Filter (Admin Only) -->
      <div class="field col-12 md:col-6 lg:col-3" *ngIf="isAdmin">
          <p-select 
            inputId="memberFilter"
            [(ngModel)]="memberFilter"
            [options]="members"
            optionValue="id"
            [filter]="true"
            filterBy="firstName,lastName,email"
            (onChange)="applyFilters()"
            placeholder="All Members"
            styleClass="w-full"
            [showClear]="true"
            appendTo="body">
            <ng-template pTemplate="selectedItem">
              <div *ngIf="memberFilter">
                {{ getSelectedMemberName() }}
              </div>
            </ng-template>
            <ng-template let-member pTemplate="item">
              <div>
                <div class="font-semibold">{{ member.firstName }} {{ member.lastName }}</div>
                <div class="text-sm text-600">{{ member.email }}</div>
              </div>
            </ng-template>
          </p-select>
      </div>

      <!-- Status Filter -->
      <div class="field col-12 md:col-6 lg:col-3">
          <p-select 
            inputId="statusFilter"
            [(ngModel)]="statusFilter" 
            [options]="statusOptions"
            (onChange)="applyFilters()"
            optionLabel="label"
            optionValue="value"
            placeholder="All Status"
            styleClass="w-full">
          </p-select>
      </div>

      <!-- Clear Filters Button -->
      <div class="field col-12 md:col-6 lg:col-3 flex align-items-end">
        <p-button 
          label="Clear Filters" 
          icon="pi pi-filter-slash" 
          severity="secondary"
          [outlined]="true"
          (onClick)="clearFilters()"
          styleClass="w-full">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Borrowings Table -->
  <p-card>
    <ng-template pTemplate="header">
      <div class="flex align-items-center justify-content-between px-3 pt-3">
        <div>
          <h3 class="text-xl font-semibold m-0 text-900">Borrowings List</h3>
          <p class="text-sm text-600 mt-1 mb-0">Total: {{ filteredBorrowings.length }} borrowings</p>
        </div>
      </div>
    </ng-template>

    <p-table 
      [value]="filteredBorrowings" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} borrowings"
      styleClass="p-datatable-sm"
      [tableStyle]="{ 'min-width': '75rem' }">
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="book.title">Book Title
            <p-sortIcon field="book.title"></p-sortIcon>
          </th>
          <th pSortableColumn="member.firstName" *ngIf="isAdmin">Member
            <p-sortIcon field="member.firstName"></p-sortIcon>
          </th>
          <th pSortableColumn="borrowDate">Borrow Date
            <p-sortIcon field="borrowDate"></p-sortIcon>
          </th>
          <th pSortableColumn="dueDate">Due Date
            <p-sortIcon field="dueDate"></p-sortIcon>
          </th>
          <th pSortableColumn="returnDate">Return Date
            <p-sortIcon field="returnDate"></p-sortIcon>
          </th>
          <th pSortableColumn="status">Status
            <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th pSortableColumn="lateFee">Late Fee</th>
          <th *ngIf="isAdmin">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-borrowing>
        <tr>
          <td>
            <span class="font-semibold">{{ borrowing.book.title }}</span>
            <br>
            <small class="text-600">by {{ borrowing.book.author }}</small>
          </td>
          <td *ngIf="isAdmin">
            <span>{{ getMemberFullName(borrowing) }}</span>
            <br>
            <small class="text-600">{{ borrowing.member.email }}</small>
          </td>
          <td>{{ borrowing.borrowDate }}</td>
          <td>{{ borrowing.dueDate }}</td>
          <td>
            <span *ngIf="borrowing.returnDate">{{ borrowing.returnDate }}</span>
            <span *ngIf="!borrowing.returnDate" class="text-500">Not returned</span>
          </td>
          <td>
            <p-tag 
              [value]="borrowing.status" 
              [severity]="getStatusSeverity(borrowing.status)">
            </p-tag>
          </td>
          <td>
            <span *ngIf="borrowing.lateFee > 0" class="font-bold text-red-500">
              ${{ borrowing.lateFee.toFixed(2) }}
            </span>
            <span *ngIf="borrowing.lateFee === 0" class="text-500">
              $0.00
            </span>
          </td>
          <td *ngIf="isAdmin">
            <p-button 
              *ngIf="canReturn(borrowing)"
              label="Return"
              icon="pi pi-check" 
              severity="success"
              size="small"
              [outlined]="true"
              (onClick)="confirmReturnBook(borrowing)">
            </p-button>
            <span *ngIf="!canReturn(borrowing)" class="text-500">-</span>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="isAdmin ? 8 : 7" class="text-center py-5">
            <i class="pi pi-inbox text-4xl text-400 mb-3"></i>
            <p class="text-600">No borrowings found.</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
