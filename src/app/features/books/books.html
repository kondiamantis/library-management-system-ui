<div class="p-2">
  <!-- Confirm Dialog -->
  <p-confirmdialog></p-confirmdialog>

  <!-- Borrow Book Dialog -->
  <p-dialog 
    [(visible)]="borrowDialogVisible"
    [modal]="true"
    [style]="{ width: '400px' }"
    [header]="'Confirm Borrowing'"
    (onHide)="closeBorrowDialog()">
    
    <div class="flex flex-column gap-3 py-3">
      <!-- Book Title -->
      <div class="text-center">
        <i class="pi pi-book text-5xl text-primary mb-3"></i>
        <h3 class="text-xl font-bold text-900 m-0 mb-2">{{ selectedBookToBorrow?.title }}</h3>
        <p class="text-sm text-600 m-0">by {{ selectedBookToBorrow?.author }}</p>
      </div>

      <!-- Member Selection (Only for Admins) -->
      <div class="field mb-0" *ngIf="isAdmin">
        <p-floatlabel>
          <p-select 
            inputId="selectMember"
            [(ngModel)]="selectedMemberId"
            [options]="members"
            optionValue="id"
            [filter]="true"
            filterBy="firstName,lastName,email"
            placeholder="Select a member"
            styleClass="w-full"
            [showClear]="true"
            appendTo="body">
            <ng-template pTemplate="selectedItem">
              <div *ngIf="selectedMemberId">
                {{ getSelectedMemberName() }}
              </div>
            </ng-template>
            <ng-template let-member pTemplate="item">
              <div>
                <div class="font-semibold">{{ getMemberFullName(member) }}</div>
                <div class="text-sm text-600">{{ member.email }}</div>
              </div>
            </ng-template>
          </p-select>
          <label for="selectMember">Select Member *</label>
        </p-floatlabel>
      </div>

      <!-- Return Date Info -->
      <div class="p-3 surface-100 border-round text-center">
        <p class="text-sm text-600 m-0 mb-1">Return by:</p>
        <p class="text-2xl font-bold text-primary m-0">{{ getReturnDate() | date:'MMM dd, yyyy' }}</p>
        <small class="text-600">({{ borrowingDays }} days from today)</small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex gap-2 justify-content-end">
        <p-button 
          label="Cancel" 
          severity="secondary"
          [outlined]="true"
          (onClick)="closeBorrowDialog()">
        </p-button>
        <p-button 
          label="Borrow Book" 
          icon="pi pi-check"
          severity="success"
          [disabled]="!selectedMemberId"
          (onClick)="confirmBorrowing()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
  
  <!-- Search and Filter Section -->
  <p-card class="mb-2">
    <ng-template pTemplate="header">
      <div class="px-3 pt-3">
        <h2 class="text-2xl font-bold m-0 text-900">Book Management</h2>
        <!-- <p class="text-sm text-600 mt-1 mb-0">Search and filter books in the library</p> -->
      </div>
    </ng-template>
    
    <div class="formgrid grid">
      <!-- Title Search -->
      <div class="field col-12 md:col-6 lg:col-4">
        <p-floatlabel>
          <input 
            pInputText 
            id="searchTitle" 
            [(ngModel)]="searchTitle" 
            (input)="applyFilters()"
            class="w-full" />
          <label for="searchTitle">Title</label>
        </p-floatlabel>
      </div>

      <!-- Author Search -->
      <div class="field col-12 md:col-6 lg:col-4">
        <p-floatlabel>
          <input 
            pInputText 
            id="searchAuthor" 
            [(ngModel)]="searchAuthor" 
            (input)="applyFilters()"
            class="w-full" />
          <label for="searchAuthor">Author</label>
        </p-floatlabel>
      </div>

      <!-- Publication Year -->
      <div class="field col-12 md:col-6 lg:col-4">
        <p-floatlabel>
          <p-inputnumber 
            inputId="searchYear" 
            [(ngModel)]="searchYear" 
            (onInput)="applyFilters()"
            [useGrouping]="false"
            styleClass="w-full">
          </p-inputnumber>
          <label for="searchYear">Publication Year</label>
        </p-floatlabel>
      </div>

      <!-- Status Filter -->
      <div class="field col-12 md:col-6 lg:col-4">
        <p-select 
          inputId="searchStatus"
          [(ngModel)]="searchStatus" 
          [options]="statusOptions"
          (onChange)="applyFilters()"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full">
        </p-select>
      </div>

      <!-- Genre Filter -->
      <div class="field col-12 md:col-6 lg:col-4">
        
          <p-select 
            inputId="searchGenre"
            [(ngModel)]="searchGenre" 
            [options]="genreOptions"
            (onChange)="applyFilters()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full">
          </p-select>
      </div>

      <!-- Clear Filters Button -->
      <div class="field col-12 md:col-6 lg:col-4 flex align-items-end">
        <p-button 
          label="Clear Filters" 
          icon="pi pi-filter-slash" 
          severity="secondary"
          [outlined]="true"
          (onClick)="clearFilters()"
          styleClass="w-full">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Books Table -->
  <p-card>
    <ng-template pTemplate="header">
      <div class="flex align-items-center justify-content-between px-3 pt-3">
        <div>
          <h3 class="text-xl font-semibold m-0 text-900">Books List</h3>
          <p class="text-sm text-600 mt-1 mb-0">Total: {{ filteredBooks.length }} books</p>
        </div>
        <div class="flex gap-2" *ngIf="canCreateBook">
          <p-button 
            label="Add New Book"
            icon="pi pi-plus" 
            (onClick)="openCreateForm()"
            severity="info">
          </p-button>
        </div>
      </div>
    </ng-template>

    <p-table 
      [value]="filteredBooks" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 25]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} books"
      styleClass="p-datatable-sm"
      [tableStyle]="{ 'min-width': '75rem' }"
      stripedRows>
      
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="title">Title
            <p-sortIcon field="title"></p-sortIcon>
          </th>
          <th pSortableColumn="author">Author
            <p-sortIcon field="author"></p-sortIcon>
          </th>
          <th pSortableColumn="genre">Genre
            <p-sortIcon field="genre"></p-sortIcon>
          </th>
          <th pSortableColumn="publicationYear">Year
            <p-sortIcon field="publicationYear"></p-sortIcon>
          </th>
          <th pSortableColumn="availableCopies">Available
            <p-sortIcon field="availableCopies"></p-sortIcon>
          </th>
          <th pSortableColumn="totalCopies">Total
            <p-sortIcon field="totalCopies"></p-sortIcon>
          </th>
          <th>Status
            <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-book>
        <tr>
          <td>
            <span class="font-semibold">{{ book.title }}</span>
            <br>
            <small class="text-600">ISBN: {{ book.isbn }}</small>
          </td>
          <td>{{ book.author }}</td>
          <td>
            <p-tag [value]="book.genre" severity="secondary"></p-tag>
          </td>
          <td>{{ book.publicationYear }}</td>
          <td>
            <span class="font-bold">{{ book.availableCopies }}</span>
          </td>
          <td>{{ book.totalCopies }}</td>
          <td>
            <p-tag 
              [value]="getAvailabilityLabel(book)" 
              [severity]="getAvailabilityStatus(book)">
            </p-tag>
          </td>
          <td>
            <div class="flex gap-2">
              <p-button 
                *ngIf="canEditBook"
                icon="pi pi-pencil" 
                [rounded]="true"
                [outlined]="true"
                severity="warn"
                size="small"
                (onClick)="openEditSidebar(book)"
                pTooltip="Edit Book"
                tooltipPosition="top">
              </p-button>
              <p-button 
                icon="pi pi-book" 
                [rounded]="true"
                [outlined]="true"
                severity="success"
                size="small"
                [disabled]="book.availableCopies === 0"
                (onClick)="borrowBook(book)"
                pTooltip="Borrow Book"
                tooltipPosition="top">
              </p-button>
              <p-button 
                *ngIf="canDeleteBook"
                icon="pi pi-trash" 
                [rounded]="true"
                [outlined]="true"
                severity="danger"
                size="small"
                (onClick)="confirmDelete(book)"
                pTooltip="Delete Book"
                tooltipPosition="top">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-5">
            <i class="pi pi-book text-4xl text-400 mb-3"></i>
            <p class="text-600">No books found. Try adjusting your filters.</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Edit Drawer -->
<p-drawer 
  [(visible)]="sidebarVisible" 
  position="right" 
  [style]="{ width: '30rem' }"
  (onHide)="closeSidebar()">
  
  <ng-template pTemplate="header">
    <div class="flex align-items-center gap-2">
      <i [class]="editMode ? 'pi pi-pencil text-xl' : 'pi pi-plus text-xl'"></i>
      <span class="font-bold text-xl">{{ editMode ? 'Edit Book' : 'Add New Book' }}</span>
    </div>
  </ng-template>

  <div class="flex flex-column gap-4 pt-3">
    <!-- Title -->
    <div class="field">
      <p-floatlabel>
        <input 
          pInputText 
          id="editTitle" 
          [(ngModel)]="editedBook.title"
          class="w-full" />
        <label for="editTitle">Title *</label>
      </p-floatlabel>
    </div>

    <!-- Author -->
    <div class="field">
      <p-floatlabel>
        <input 
          pInputText 
          id="editAuthor" 
          [(ngModel)]="editedBook.author"
          class="w-full" />
        <label for="editAuthor">Author *</label>
      </p-floatlabel>
    </div>

    <!-- ISBN -->
    <div class="field">
      <p-floatlabel>
        <input 
          pInputText 
          id="editIsbn" 
          [(ngModel)]="editedBook.isbn"
          (blur)="validateISBN(editedBook.isbn)"
          (input)="isbnError = ''"
          [class.ng-invalid]="isbnError"
          class="w-full" />
        <label for="editIsbn">ISBN *</label>
      </p-floatlabel>
      <small *ngIf="isbnError" class="p-error">{{ isbnError }}</small>
      <small *ngIf="!isbnError && editedBook.isbn" class="text-600">
        Format: 10 digits (ISBN-10) or 13 digits starting with 978/979 (ISBN-13). Hyphens and spaces are optional.
      </small>
    </div>

    <!-- Genre -->
    <div class="field">
      <p-floatlabel>
        <p-select 
          inputId="editGenre"
          [(ngModel)]="editedBook.genre" 
          [options]="editGenreOptions"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full">
        </p-select>
        <label for="editGenre">Genre *</label>
      </p-floatlabel>
    </div>

    <!-- Publication Year -->
    <div class="field">
      <p-floatlabel>
        <p-inputnumber 
          inputId="editYear" 
          [(ngModel)]="editedBook.publicationYear"
          [useGrouping]="false"
          styleClass="w-full">
        </p-inputnumber>
        <label for="editYear">Publication Year</label>
      </p-floatlabel>
    </div>

    <!-- Total Copies -->
    <div class="field">
      <p-floatlabel>
        <p-inputnumber 
          inputId="editTotalCopies" 
          [(ngModel)]="editedBook.totalCopies"
          [min]="0"
          styleClass="w-full">
        </p-inputnumber>
        <label for="editTotalCopies">Total Copies *</label>
      </p-floatlabel>
    </div>

    <!-- Available Copies -->
    <div class="field">
      <p-floatlabel>
        <p-inputnumber 
          inputId="editAvailableCopies" 
          [(ngModel)]="editedBook.availableCopies"
          [min]="0"
          [max]="editedBook.totalCopies"
          styleClass="w-full">
        </p-inputnumber>
        <label for="editAvailableCopies">Available Copies *</label>
      </p-floatlabel>
    </div>

    <!-- Description -->
    <div class="field">
      <p-floatlabel>
        <textarea 
          pTextarea
          id="editDescription" 
          [(ngModel)]="editedBook.description"
          rows="4"
          class="w-full">
        </textarea>
        <label for="editDescription">Description</label>
      </p-floatlabel>
    </div>

    <!-- Cover URL -->
    <div class="field">
      <p-floatlabel>
        <input 
          pInputText 
          id="editCoverUrl" 
          [(ngModel)]="editedBook.coverUrl"
          class="w-full" />
        <label for="editCoverUrl">Cover URL</label>
      </p-floatlabel>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-content-end">
      <p-button 
        label="Cancel" 
        severity="secondary"
        [outlined]="true"
        (onClick)="closeSidebar()">
      </p-button>
      <p-button 
        [label]="editMode ? 'Save Changes' : 'Create Book'" 
        icon="pi pi-check"
        (onClick)="saveBook()">
      </p-button>
    </div>
  </ng-template>
</p-drawer>